<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBot クラス図ビューア</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.25.0/cytoscape.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f5f5f5;
        }
        
        header {
            background-color: #0078d7;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background-color: #e0e0e0;
            border-bottom: 1px solid #ccc;
        }
        
        button {
            padding: 0.5rem 1rem;
            background-color: #0078d7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        button:hover {
            background-color: #005a9e;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        label {
            font-size: 0.9rem;
        }
        
        select {
            padding: 0.4rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 300px;
            background-color: #fff;
            border-right: 1px solid #ccc;
            padding: 1rem;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .class-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .class-list li {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .class-list li:hover {
            background-color: #f0f0f0;
        }
        
        .class-list li.active {
            background-color: #e6f3ff;
            font-weight: bold;
        }
        
        .class-category {
            margin-bottom: 1rem;
        }
        
        .class-category h3 {
            margin: 0;
            padding: 0.5rem 0;
            font-size: 1.1rem;
            border-bottom: 2px solid #0078d7;
        }
        
        .graph-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #cy {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .class-details {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 300px;
            max-height: 500px;
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 1rem;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: none;
        }
        
        .class-details h3 {
            margin-top: 0;
            color: #0078d7;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .method-list, .property-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .method-list li, .property-list li {
            margin-bottom: 0.3rem;
            padding: 0.3rem;
            border-radius: 3px;
        }
        
        .method-list li {
            background-color: #e6f3ff;
        }
        
        .property-list li {
            background-color: #f0f8ff;
        }
        
        .public {
            color: #008000;
        }
        
        .private {
            color: #c00000;
        }
        
        .legend {
            position: absolute;
            left: 20px;
            bottom: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 1rem;
            z-index: 10;
        }
        
        .legend h4 {
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.3rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
            border: 1px solid #ccc;
        }
        
        .node-core { background-color: #bae1ff; }
        .node-chat { background-color: #baffc9; }
        .node-file { background-color: #ffdfba; }
        .node-modal { background-color: #ffb3ba; }
        .node-util { background-color: #ffffba; }
        .node-sidebar { background-color: #e2baff; }
        .node-executor { background-color: #bae1ff; }
    </style>
</head>
<body>
    <header>
        <h1>ChatBot クラス図ビューア</h1>
        <div>
            <button id="helpBtn">ヘルプ</button>
        </div>
    </header>
    
    <div class="controls">
        <div class="filter-group">
            <label for="layoutSelect">レイアウト:</label>
            <select id="layoutSelect">
                <option value="cose">標準</option>
                <option value="breadthfirst">階層型</option>
                <option value="circle">円形</option>
                <option value="grid">グリッド</option>
                <option value="concentric">同心円</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="categoryFilter">カテゴリ:</label>
            <select id="categoryFilter">
                <option value="all">全て</option>
                <option value="core">コア</option>
                <option value="chat">チャット</option>
                <option value="file">ファイル</option>
                <option value="util">ユーティリティ</option>
                <option value="modal">モーダル</option>
                <option value="sidebar">サイドバー</option>
                <option value="executor">実行</option>
            </select>
        </div>
        
        <button id="resetBtn">リセット</button>
        <button id="exportBtn">画像エクスポート</button>
    </div>
    
    <div class="content">
        <div class="sidebar">
            <div class="class-category">
                <h3>コアクラス</h3>
                <ul class="class-list" id="coreClassList"></ul>
            </div>
            
            <div class="class-category">
                <h3>チャットコンポーネント</h3>
                <ul class="class-list" id="chatClassList"></ul>
            </div>
            
            <div class="class-category">
                <h3>ファイル関連</h3>
                <ul class="class-list" id="fileClassList"></ul>
            </div>
            
            <div class="class-category">
                <h3>ユーティリティ</h3>
                <ul class="class-list" id="utilClassList"></ul>
            </div>
            
            <div class="class-category">
                <h3>モーダル</h3>
                <ul class="class-list" id="modalClassList"></ul>
            </div>
            
            <div class="class-category">
                <h3>サイドバー</h3>
                <ul class="class-list" id="sidebarClassList"></ul>
            </div>
            
            <div class="class-category">
                <h3>コード実行</h3>
                <ul class="class-list" id="executorClassList"></ul>
            </div>
        </div>
        
        <div class="graph-container">
            <div id="cy"></div>
            
            <div class="class-details" id="classDetails">
                <h3 id="detailsTitle">クラス詳細</h3>
                
                <h4>プロパティ:</h4>
                <ul class="property-list" id="propertyList"></ul>
                
                <h4>メソッド:</h4>
                <ul class="method-list" id="methodList"></ul>
            </div>
            
            <div class="legend">
                <h4>凡例</h4>
                <div class="legend-item">
                    <div class="legend-color node-core"></div>
                    <span>コア</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color node-chat"></div>
                    <span>チャット</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color node-file"></div>
                    <span>ファイル</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color node-util"></div>
                    <span>ユーティリティ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color node-modal"></div>
                    <span>モーダル</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color node-sidebar"></div>
                    <span>サイドバー</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color node-executor"></div>
                    <span>実行</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // クラス定義データ
        const classData = {
            // コアクラス
            "UI": {
                category: "core",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "initialize()", access: "public" }
                ]
            },
            "Storage": {
                category: "core",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "setItem(key, value)", access: "public" },
                    { name: "getItem(key)", access: "public" },
                    { name: "saveConversations()", access: "public" },
                    { name: "loadConversations()", access: "public" },
                    { name: "saveSystemPrompt()", access: "public" },
                    { name: "loadSystemPrompt()", access: "public" },
                    { name: "saveApiSettings()", access: "public" },
                    { name: "loadApiSettings()", access: "public" },
                    { name: "saveAttachments()", access: "public" },
                    { name: "loadAttachments()", access: "public" },
                    { name: "saveCategoryState()", access: "public" },
                    { name: "loadCategoryState()", access: "public" }
                ]
            },
            "UIUtils": {
                category: "core",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "toggleVisibility()", access: "public" },
                    { name: "toggleModal()", access: "public" },
                    { name: "createElement(tag, props)", access: "public" },
                    { name: "autoResizeTextarea()", access: "public" },
                    { name: "scrollToBottom()", access: "public" }
                ]
            },
            "UICache": {
                category: "core",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "get(selector, useQuerySelector)", access: "public" },
                    { name: "set(selector, element)", access: "public" },
                    { name: "clear()", access: "public" }
                ]
            },
            "EventHandlers": {
                category: "core",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "setupChatEvents()", access: "public" },
                    { name: "setupSettingsEvents()", access: "public" },
                    { name: "setupFileEvents()", access: "public" },
                    { name: "setupGlobalEvents()", access: "public" },
                    { name: "setupModalEvents()", access: "public" },
                    { name: "#setupSystemPromptModal()", access: "private" },
                    { name: "#setupApiKeyModal()", access: "private" },
                    { name: "#setupRenameChatModal()", access: "private" },
                    { name: "#setupPromptManagerModal()", access: "private" }
                ]
            },
            "AIAPI": {
                category: "core",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "sendMessage()", access: "public" },
                    { name: "sendMessageStream()", access: "public" },
                    { name: "processAttachments()", access: "private" },
                    { name: "performOpenAIRequest()", access: "private" },
                    { name: "performAzureRequest()", access: "private" }
                ]
            },
            
            // チャットコンポーネント
            "ChatActions": {
                category: "chat",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "sendMessage()", access: "public" },
                    { name: "createNewConversation()", access: "public" },
                    { name: "clearAllHistory()", access: "public" },
                    { name: "renderChatHistory()", access: "public" },
                    { name: "#switchConversation()", access: "private" },
                    { name: "#deleteConversation()", access: "private" }
                ]
            },
            "ChatHistory": {
                category: "chat",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "renderChatHistory()", access: "public" },
                    { name: "updateActiveChatInHistory()", access: "public" },
                    { name: "displayConversation()", access: "public" },
                    { name: "formatTimestamp()", access: "private" }
                ]
            },
            "ChatRenderer": {
                category: "chat",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "renderUserMessage()", access: "public" },
                    { name: "renderBotMessage()", access: "public" },
                    { name: "clearStreamingMessage()", access: "public" },
                    { name: "updateStreamingMessage()", access: "public" },
                    { name: "highlightCode()", access: "private" }
                ]
            },
            "ChatAttachmentViewer": {
                category: "chat",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "createAttachmentsElement()", access: "public" },
                    { name: "showFullSizeImage()", access: "public" },
                    { name: "createImageAttachment()", access: "private" },
                    { name: "createFileAttachment()", access: "private" },
                    { name: "formatTextContent()", access: "private" }
                ]
            },
            "ChatUI": {
                category: "chat",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "createElement(tag, options)", access: "public" },
                    { name: "formatTimestamp()", access: "public" },
                    { name: "adjustScroll()", access: "public" },
                    { name: "initializeCodeEditor()", access: "public" },
                    { name: "showCodeEditor()", access: "public" },
                    { name: "#executeEditorCode()", access: "private" }
                ]
            },
            
            // ファイル関連クラス
            "FileAttachment": {
                category: "file",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "clearAttachments()", access: "public" },
                    { name: "getAttachmentsForAPI()", access: "public" },
                    { name: "saveAttachmentsForConversation()", access: "public" },
                    { name: "displaySavedAttachments()", access: "public" },
                    { name: "loadAttachmentsForConversation()", access: "private" },
                    { name: "findClosestMessageIndex()", access: "private" }
                ]
            },
            "FileAttachmentUI": {
                category: "file",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "updatePreview()", access: "public" },
                    { name: "clearPreview()", access: "public" },
                    { name: "#getOrCreatePreviewArea()", access: "private" },
                    { name: "#createFilePreviewItems()", access: "private" },
                    { name: "#createFilePreview()", access: "private" },
                    { name: "#createImagePreview()", access: "private" },
                    { name: "#createFileInfo()", access: "private" }
                ]
            },
            "FileHandler": {
                category: "file",
                properties: [
                    { name: "static #instance", access: "private" },
                    { name: "selectedFiles", access: "public" },
                    { name: "savedAttachments", access: "public" },
                    { name: "attachmentTimestamp", access: "public" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "init()", access: "public" },
                    { name: "updateAcceptedFileTypes()", access: "public" },
                    { name: "handleFileSelect()", access: "public" },
                    { name: "notifyAttachmentComplete()", access: "public" },
                    { name: "clearSelectedFiles()", access: "public" },
                    { name: "getAllowedFileExtensions()", access: "private" }
                ]
            },
            "FileConverter": {
                category: "file",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "convertFilesToAttachments()", access: "public" },
                    { name: "convertFileToAttachment()", access: "private" },
                    { name: "convertImageToAttachment()", access: "private" },
                    { name: "convertTextToAttachment()", access: "private" }
                ]
            },
            "FileReaderUtil": {
                category: "file",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "readAsDataURL()", access: "public" },
                    { name: "readAsText()", access: "public" },
                    { name: "readAsArrayBuffer()", access: "public" }
                ]
            },
            "FileValidator": {
                category: "file",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "validateFiles()", access: "public" },
                    { name: "checkFileType()", access: "private" },
                    { name: "checkFileSize()", access: "private" },
                    { name: "checkFileExtension()", access: "private" }
                ]
            },
            
            // ユーティリティクラス
            "Markdown": {
                category: "util",
                properties: [
                    { name: "static #instance", access: "private" },
                    { name: "_libraryStatus", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "initializeMarkdown()", access: "public" },
                    { name: "loadScript()", access: "public" },
                    { name: "renderMarkdown()", access: "public" },
                    { name: "escapeHtml()", access: "public" },
                    { name: "getCodeLanguage()", access: "public" }
                ]
            },
            "CryptoHelper": {
                category: "util",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "encrypt()", access: "public" },
                    { name: "decrypt()", access: "public" },
                    { name: "generateEncryptionKey()", access: "private" }
                ]
            },
            
            // モーダルクラス
            "ApiSettingsModal": {
                category: "modal",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "showApiKeyModal()", access: "public" },
                    { name: "hideApiKeyModal()", access: "public" },
                    { name: "toggleAzureSettings()", access: "public" }
                ]
            },
            "SystemPromptModal": {
                category: "modal",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "showSystemPromptModal()", access: "public" },
                    { name: "hideSystemPromptModal()", access: "public" },
                    { name: "updateList()", access: "public" },
                    { name: "createPromptItem()", access: "private" }
                ]
            },
            "PromptManagerModal": {
                category: "modal",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "showPromptManagerModal()", access: "public" },
                    { name: "hidePromptManagerModal()", access: "public" },
                    { name: "showPromptEditModal()", access: "public" },
                    { name: "hidePromptEditModal()", access: "public" },
                    { name: "handleAddCategory()", access: "public" },
                    { name: "updatePromptCategories()", access: "private" }
                ]
            },
            "RenameChatModal": {
                category: "modal",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "showRenameChatModal()", access: "public" },
                    { name: "hideRenameChatModal()", access: "public" }
                ]
            },
            "ModalHandlers": {
                category: "modal",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "saveApiSettings()", access: "public" },
                    { name: "saveRenamedChat()", access: "public" },
                    { name: "saveNewSystemPrompt()", access: "public" },
                    { name: "onTemplateSelect()", access: "public" },
                    { name: "onTemplateDelete()", access: "public" }
                ]
            },
            
            // サイドバークラス
            "Sidebar": {
                category: "sidebar",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "toggleSidebar()", access: "public" },
                    { name: "createToggleButton()", access: "public" },
                    { name: "handleResize()", access: "private" }
                ]
            },
            
            // コード実行クラス
            "ExecutorBase": {
                category: "executor",
                properties: [],
                methods: [
                    { name: "execute(code)*", access: "public" },
                    { name: "_loadRuntime()*", access: "protected" },
                    { name: "_executeCode(code)*", access: "protected" },
                    { name: "_formatResult(result)*", access: "protected" }
                ]
            },
            "JavaScriptExecutor": {
                category: "executor",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "execute(code)", access: "public" },
                    { name: "_loadRuntime()", access: "protected" },
                    { name: "_executeCode(code)", access: "protected" },
                    { name: "_formatResult(result)", access: "protected" }
                ]
            },
            "PythonExecutor": {
                category: "executor",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "execute(code)", access: "public" },
                    { name: "_loadRuntime()", access: "protected" },
                    { name: "_executeCode(code)", access: "protected" },
                    { name: "_formatResult(result)", access: "protected" }
                ]
            },
            "CPPExecutor": {
                category: "executor",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "execute(code)", access: "public" },
                    { name: "_loadRuntime()", access: "protected" },
                    { name: "_executeCode(code)", access: "protected" },
                    { name: "_formatResult(result)", access: "protected" }
                ]
            },
            "HTMLExecutor": {
                category: "executor",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "execute(code)", access: "public" },
                    { name: "_loadRuntime()", access: "protected" },
                    { name: "_executeCode(code)", access: "protected" },
                    { name: "_formatResult(result)", access: "protected" }
                ]
            },
            "CodeExecutor": {
                category: "executor",
                properties: [
                    { name: "static #instance", access: "private" }
                ],
                methods: [
                    { name: "static getInstance()", access: "public" },
                    { name: "constructor()", access: "private" },
                    { name: "detectLanguage()", access: "public" },
                    { name: "execute()", access: "public" },
                    { name: "getExecutor()", access: "private" }
                ]
            }
        };
        
        // クラスの依存関係データ
        const relationshipData = [
            // 継承関係
            { source: "ExecutorBase", target: "JavaScriptExecutor", type: "inheritance" },
            { source: "ExecutorBase", target: "PythonExecutor", type: "inheritance" },
            { source: "ExecutorBase", target: "CPPExecutor", type: "inheritance" },
            { source: "ExecutorBase", target: "HTMLExecutor", type: "inheritance" },
            
            // コアクラス間の関係
            { source: "UI", target: "UICache", type: "dependency" },
            { source: "UI", target: "UIUtils", type: "dependency" },
            { source: "UI", target: "Storage", type: "weak-dependency", label: "設定読み込み・保存" },
            { source: "EventHandlers", target: "UICache", type: "dependency", label: "DOM要素取得" },
            { source: "EventHandlers", target: "ChatActions", type: "dependency", label: "イベント委譲" },
            { source: "EventHandlers", target: "FileHandler", type: "dependency", label: "イベント委譲" },
            { source: "EventHandlers", target: "ModalHandlers", type: "dependency", label: "イベント委譲" },
            
            // モーダル関連
            { source: "EventHandlers", target: "ApiSettingsModal", type: "dependency", label: "モーダル表示・非表示" },
            { source: "EventHandlers", target: "SystemPromptModal", type: "dependency", label: "モーダル表示・非表示" },
            { source: "EventHandlers", target: "RenameChatModal", type: "dependency", label: "モーダル表示・非表示" },
            { source: "EventHandlers", target: "PromptManagerModal", type: "dependency", label: "モーダル表示・非表示" },
            { source: "ModalHandlers", target: "ApiSettingsModal", type: "dependency", label: "モーダル制御" },
            { source: "ModalHandlers", target: "SystemPromptModal", type: "dependency", label: "モーダル制御" },
            { source: "ModalHandlers", target: "RenameChatModal", type: "dependency", label: "モーダル制御" },
            { source: "ModalHandlers", target: "PromptManagerModal", type: "dependency", label: "モーダル制御" },
            { source: "ModalHandlers", target: "Storage", type: "dependency", label: "設定保存" },
            { source: "ModalHandlers", target: "UICache", type: "dependency", label: "DOM要素取得" },
            { source: "ModalHandlers", target: "UI", type: "dependency", label: "通知表示" },
            { source: "ApiSettingsModal", target: "UICache", type: "dependency", label: "DOM要素取得" },
            { source: "SystemPromptModal", target: "UICache", type: "dependency", label: "DOM要素取得" },
            { source: "SystemPromptModal", target: "Storage", type: "dependency", label: "テンプレート取得" },
            { source: "RenameChatModal", target: "UICache", type: "dependency", label: "DOM要素取得" },
            { source: "PromptManagerModal", target: "UICache", type: "dependency", label: "DOM要素取得" },
            { source: "PromptManagerModal", target: "Storage", type: "dependency", label: "テンプレート取得" },
            
            // ファイル関連
            { source: "FileHandler", target: "FileValidator", type: "dependency", label: "ファイル検証" },
            { source: "FileHandler", target: "FileAttachmentUI", type: "dependency", label: "プレビュー更新" },
            { source: "FileHandler", target: "FileConverter", type: "dependency", label: "ファイル変換" },
            { source: "FileAttachment", target: "Storage", type: "dependency", label: "添付ファイル保存・読込" },
            { source: "FileAttachment", target: "FileHandler", type: "dependency", label: "ファイル情報取得" },
            { source: "FileAttachment", target: "ChatAttachmentViewer", type: "dependency", label: "添付ファイル表示" },
            { source: "FileAttachmentUI", target: "FileHandler", type: "dependency", label: "ファイル情報取得" },
            { source: "FileConverter", target: "FileReaderUtil", type: "dependency", label: "ファイル読込" },
            
            // チャット関連
            { source: "ChatActions", target: "AIAPI", type: "dependency", label: "API通信" },
            { source: "ChatActions", target: "Storage", type: "dependency", label: "会話保存・読込" },
            { source: "ChatActions", target: "ChatHistory", type: "dependency", label: "会話表示" },
            { source: "ChatActions", target: "ChatRenderer", type: "dependency", label: "メッセージ表示" },
            { source: "ChatActions", target: "FileAttachment", type: "dependency", label: "添付ファイル処理" },
            { source: "ChatActions", target: "FileHandler", type: "dependency", label: "ファイル処理" },
            { source: "ChatActions", target: "UIUtils", type: "dependency", label: "テキストエリアリサイズ" },
            { source: "ChatActions", target: "RenameChatModal", type: "dependency", label: "モーダル表示" },
            { source: "ChatHistory", target: "UIUtils", type: "dependency", label: "スクロール制御" },
            { source: "ChatHistory", target: "ChatRenderer", type: "dependency", label: "メッセージ表示" },
            { source: "ChatHistory", target: "ChatUI", type: "dependency", label: "要素生成" },
            { source: "ChatHistory", target: "FileAttachment", type: "dependency", label: "添付ファイル表示" },
            { source: "ChatRenderer", target: "Markdown", type: "dependency", label: "マークダウン処理" },
            { source: "ChatRenderer", target: "UIUtils", type: "dependency", label: "DOM要素生成" },
            { source: "ChatRenderer", target: "ChatUI", type: "dependency", label: "要素生成" },
            { source: "ChatRenderer", target: "ChatAttachmentViewer", type: "dependency", label: "添付ファイル表示" },
            { source: "ChatRenderer", target: "CodeExecutor", type: "dependency", label: "コード実行" },
            { source: "ChatAttachmentViewer", target: "Markdown", type: "dependency", label: "コード表示処理" },
            { source: "ChatAttachmentViewer", target: "ChatUI", type: "dependency", label: "要素生成" },
            
            // コード実行関連
            { source: "CodeExecutor", target: "JavaScriptExecutor", type: "dependency", label: "実行委譲" },
            { source: "CodeExecutor", target: "PythonExecutor", type: "dependency", label: "実行委譲" },
            { source: "CodeExecutor", target: "CPPExecutor", type: "dependency", label: "実行委譲" },
            { source: "CodeExecutor", target: "HTMLExecutor", type: "dependency", label: "実行委譲" },
            
            // サイドバー関連
            { source: "Sidebar", target: "UICache", type: "dependency", label: "DOM要素取得" },
            
            // API関連
            { source: "AIAPI", target: "CryptoHelper", type: "dependency", label: "APIキー復号化" },
            { source: "AIAPI", target: "FileConverter", type: "dependency", label: "添付ファイル処理" },
            { source: "AIAPI", target: "Storage", type: "dependency", label: "API設定取得" }
        ];
        
        document.addEventListener('DOMContentLoaded', function() {
            populateClassLists();
            initCytoscape();
            setupEventListeners();
        });
        
        function populateClassLists() {
            const classListsByCategory = {
                'core': document.getElementById('coreClassList'),
                'chat': document.getElementById('chatClassList'),
                'file': document.getElementById('fileClassList'),
                'util': document.getElementById('utilClassList'),
                'modal': document.getElementById('modalClassList'),
                'sidebar': document.getElementById('sidebarClassList'),
                'executor': document.getElementById('executorClassList')
            };
            
            Object.keys(classData).forEach(className => {
                const category = classData[className].category;
                const listElement = classListsByCategory[category];
                
                if (listElement) {
                    const li = document.createElement('li');
                    li.textContent = className;
                    li.dataset.className = className;
                    li.addEventListener('click', function() {
                        highlightClass(className);
                        showClassDetails(className);
                    });
                    listElement.appendChild(li);
                }
            });
        }
        
        function initCytoscape() {
            const cy = window.cy = cytoscape({
                container: document.getElementById('cy'),
                elements: createCytoscapeElements(),
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(id)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '14px',
                            'font-weight': 'bold',
                            'background-color': 'data(color)',
                            'border-width': 2,
                            'border-color': '#666',
                            'width': 'label',
                            'height': 'label',
                            'padding': '10px',
                            'shape': 'roundrectangle',
                            'text-wrap': 'wrap'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#999',
                            'target-arrow-color': '#999',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'label': 'data(label)',
                            'font-size': '11px',
                            'text-rotation': 'autorotate',
                            'text-background-color': '#fff',
                            'text-background-opacity': 0.7,
                            'text-background-padding': '2px'
                        }
                    },
                    {
                        selector: 'edge[type="inheritance"]',
                        style: {
                            'line-style': 'solid',
                            'line-color': '#3333CC',
                            'target-arrow-color': '#3333CC',
                            'target-arrow-shape': 'triangle',
                            'width': 3
                        }
                    },
                    {
                        selector: 'edge[type="weak-dependency"]',
                        style: {
                            'line-style': 'dashed',
                            'line-color': '#999',
                            'target-arrow-color': '#999',
                            'target-arrow-shape': 'triangle'
                        }
                    },
                    {
                        selector: '.highlighted',
                        style: {
                            'border-width': 4,
                            'border-color': '#ff0000',
                            'border-opacity': 1
                        }
                    },
                    {
                        selector: '.related',
                        style: {
                            'border-width': 3,
                            'border-color': '#ff7700',
                            'border-opacity': 0.8
                        }
                    },
                    {
                        selector: '.faded',
                        style: {
                            'opacity': 0.3
                        }
                    },
                    {
                        selector: '.highlighted-edge',
                        style: {
                            'width': 4,
                            'line-color': '#ff7700',
                            'target-arrow-color': '#ff7700',
                            'opacity': 1
                        }
                    }
                ],
                layout: {
                    name: 'cose',
                    idealEdgeLength: 150,
                    nodeOverlap: 20,
                    nodeRepulsion: 45000,
                    edgeElasticity: 100,
                    nestingFactor: 1.2,
                    gravity: 80,
                    numIter: 1000,
                    initialTemp: 200,
                    coolingFactor: 0.95,
                    minTemp: 1.0,
                    animate: false
                },
                wheelSensitivity: 0.2
            });
            
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                highlightClass(node.id());
                showClassDetails(node.id());
            });
            
            cy.on('tap', function(evt) {
                if (evt.target === cy) {
                    resetHighlights();
                    hideClassDetails();
                }
            });
        }
        
        function createCytoscapeElements() {
            const elements = [];
            
            // カテゴリごとのカラー
            const categoryColors = {
                core: '#bae1ff',
                chat: '#baffc9',
                file: '#ffdfba',
                util: '#ffffba',
                modal: '#ffb3ba',
                sidebar: '#e2baff',
                executor: '#bae1ff'
            };
            
            // ノードを追加
            Object.keys(classData).forEach(className => {
                const classInfo = classData[className];
                elements.push({
                    data: {
                        id: className,
                        color: categoryColors[classInfo.category],
                        category: classInfo.category
                    }
                });
            });
            
            // エッジを追加
            relationshipData.forEach(rel => {
                elements.push({
                    data: {
                        source: rel.source,
                        target: rel.target,
                        type: rel.type,
                        label: rel.label || ''
                    }
                });
            });
            
            return elements;
        }
        
        function setupEventListeners() {
            document.getElementById('layoutSelect').addEventListener('change', function() {
                applyLayout(this.value);
            });
            
            document.getElementById('categoryFilter').addEventListener('change', function() {
                filterByCategory(this.value);
            });
            
            document.getElementById('resetBtn').addEventListener('click', function() {
                resetView();
            });
            
            document.getElementById('exportBtn').addEventListener('click', function() {
                exportImage();
            });
            
            document.getElementById('helpBtn').addEventListener('click', function() {
                showHelp();
            });
        }
        
        function applyLayout(layoutName) {
            const layoutConfig = {
                name: layoutName,
                animate: true,
                animationDuration: 500,
                padding: 50
            };
            
            if (layoutName === 'breadthfirst') {
                layoutConfig.directed = true;
                layoutConfig.spacingFactor = 1.5;
            } else if (layoutName === 'cose') {
                layoutConfig.idealEdgeLength = 150;
                layoutConfig.nodeOverlap = 20;
                layoutConfig.nodeRepulsion = 45000;
            }
            
            cy.layout(layoutConfig).run();
        }
        
        function filterByCategory(category) {
            if (category === 'all') {
                cy.elements().removeClass('faded').removeClass('highlighted');
                return;
            }
            
            cy.elements().addClass('faded');
            
            const selectedNodes = cy.nodes(`[category = "${category}"]`);
            selectedNodes.removeClass('faded');
            
            selectedNodes.connectedEdges().forEach(function(edge) {
                const source = edge.source();
                const target = edge.target();
                if ((source.data('category') === category || target.data('category') === category)) {
                    edge.removeClass('faded');
                }
            });
        }
        
        function resetView() {
            cy.elements().removeClass('faded').removeClass('highlighted').removeClass('related').removeClass('highlighted-edge');
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('layoutSelect').value = 'cose';
            applyLayout('cose');
            hideClassDetails();
            
            cy.fit();
            cy.center();
        }
        
        function highlightClass(className) {
            // リセット
            cy.elements().removeClass('highlighted').removeClass('related').removeClass('highlighted-edge').addClass('faded');
            
            // 該当クラスをハイライト
            const selectedNode = cy.getElementById(className);
            selectedNode.removeClass('faded').addClass('highlighted');
            
            // 関連エッジと接続クラスをハイライト
            const connectedEdges = selectedNode.connectedEdges();
            connectedEdges.removeClass('faded').addClass('highlighted-edge');
            
            connectedEdges.forEach(function(edge) {
                const source = edge.source();
                const target = edge.target();
                
                if (source.id() !== className) {
                    source.removeClass('faded').addClass('related');
                }
                if (target.id() !== className) {
                    target.removeClass('faded').addClass('related');
                }
            });
            
            // サイドバーのリストでもハイライト
            document.querySelectorAll('.class-list li').forEach(li => {
                li.classList.remove('active');
                if (li.dataset.className === className) {
                    li.classList.add('active');
                    li.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }
        
        function showClassDetails(className) {
            const classInfo = classData[className];
            if (!classInfo) return;
            
            const detailsPanel = document.getElementById('classDetails');
            const detailsTitle = document.getElementById('detailsTitle');
            const propertyList = document.getElementById('propertyList');
            const methodList = document.getElementById('methodList');
            
            detailsTitle.textContent = className;
            propertyList.innerHTML = '';
            methodList.innerHTML = '';
            
            // プロパティ一覧を表示
            classInfo.properties.forEach(prop => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="${prop.access}">${prop.name}</span>`;
                propertyList.appendChild(li);
            });
            
            // メソッド一覧を表示
            classInfo.methods.forEach(method => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="${method.access}">${method.name}</span>`;
                methodList.appendChild(li);
            });
            
            detailsPanel.style.display = 'block';
        }
        
        function hideClassDetails() {
            document.getElementById('classDetails').style.display = 'none';
            document.querySelectorAll('.class-list li').forEach(li => {
                li.classList.remove('active');
            });
        }
        
        function resetHighlights() {
            cy.elements().removeClass('highlighted').removeClass('related').removeClass('highlighted-edge').removeClass('faded');
        }
        
        function exportImage() {
            const imgBlob = cy.png({
                output: 'blob',
                bg: 'white',
                full: true,
                scale: 2
            });
            
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(imgBlob);
            downloadLink.download = 'ChatBot_ClassDiagram.png';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
        
        function showHelp() {
            const helpText = `
            <h3>クラス図ビューアの使い方</h3>
            <p><strong>基本操作:</strong></p>
            <ul>
                <li><strong>ナビゲーション：</strong>マウスドラッグで移動、ホイールでズーム</li>
                <li><strong>クラスの選択：</strong>図の中のクラスをクリックするか、左側リストから選択</li>
                <li><strong>情報表示：</strong>クラスを選択すると詳細情報が右上に表示</li>
                <li><strong>背景をクリック：</strong>選択をクリア</li>
            </ul>
            <p><strong>コントロール:</strong></p>
            <ul>
                <li><strong>レイアウト変更：</strong>様々な配置方法に変更できます</li>
                <li><strong>カテゴリフィルタ：</strong>特定カテゴリのクラスのみ表示</li>
                <li><strong>リセット：</strong>ビューをリセット</li>
                <li><strong>画像エクスポート：</strong>現在の図をPNG画像として保存</li>
            </ul>
            <p><strong>図の見方:</strong></p>
            <ul>
                <li><strong>実線矢印：</strong>直接的な依存関係</li>
                <li><strong>点線矢印：</strong>弱い依存関係</li>
                <li><strong>青色矢印：</strong>継承関係</li>
            </ul>`;
            
            alert(helpText);
        }
    </script>
</body>
</html>
